<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <script src="https://p.trellocdn.com/power-up.min.js"></script>

    <style>
      /* RESET */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: transparent !important;
        color: #e6e6e6;
        padding: 0;
      }

      /* MAIN WRAPPER */
      .settings-wrapper {
        padding: 20px;
        background: transparent !important;
      }

      /* HEADER */
      .settings-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 22px;
        padding-bottom: 6px;
        border-bottom: 1px solid #3a3a3d;
      }

      .settings-header .icon {
        font-size: 22px;
      }

      h1 {
        font-size: 16px;
        font-weight: 600;
        color: #ffffff;
      }

      /* COLLAPSIBLE HEADER */
      .collapsible {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 0;
        cursor: pointer;
        font-size: 15px;
        font-weight: 600;
        color: #ddd;
      }

      /* TIME TRACKER BOX */
      #trackerBox {
        background: #2a2a2e;
        border: 1px solid #3d3d42;
        padding: 16px;
        border-radius: 8px;
        margin-top: 10px;
        margin-bottom: 22px;
      }

      .time-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
      }

      .elapsed-label,
      .estimated-label {
        font-size: 12px;
        opacity: 0.55;
      }

      .elapsed {
        font-size: 22px;
        font-weight: 600;
        color: #fff;
      }

      .estimated {
        font-size: 18px;
        cursor: pointer;
        text-align: right;
        color: #aee1ff;
      }

      #estimatedInput {
        display: none;
        width: 95px;
        padding: 5px;
        margin-top: 4px;
        text-align: center;
        border-radius: 6px;
        border: 1px solid #606060;
        background: #1a1a1c;
        color: #fff;
      }

      /* BUTTONS */
      .track-btn {
        width: 100%;
        padding: 12px;
        background: #1ba8ff;
        border: none;
        border-radius: 6px;
        color: white;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        margin-bottom: 10px;
      }

      .reset-btn {
        width: 100%;
        padding: 10px;
        background: #ef5350;
        border: none;
        border-radius: 6px;
        color: white;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        margin-bottom: 10px;
      }

      /* SECTION */
      .section {
        margin-top: 10px;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #3a3a3d;
      }

      /* ITEM — TEXT + DESCRIPTION + TOGGLE */
      .item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 0;
      }

      .item > div {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .item .label {
        font-size: 15px;
        font-weight: 500;
        color: #ffffff;
      }

      .item .desc {
        font-size: 12px;
        opacity: 0.6;
      }

      /* DROPDOWN */
      select {
        padding: 7px 11px;
        border-radius: 6px;
        border: 1px solid #555;
        background: #2b2b2f;
        color: #e2e2e2;
        font-size: 14px;
      }

      /* TOGGLE SWITCH */
      .toggle input {
        display: none;
      }

      .toggle-slider {
        width: 44px;
        height: 24px;
        background: #8e8e8e; /* visible light-grey track */
        border-radius: 24px;
        position: relative;
        transition: 0.25s ease;
      }

      .toggle-slider::after {
        content: "";
        width: 20px;
        height: 20px;
        background: #ffffff;
        position: absolute;
        top: 2px;
        left: 2px;
        border-radius: 50%;
        transition: 0.25s ease;
        box-shadow: 0 0 3px rgba(0, 0, 0, 0.4);
      }

      input:checked + .toggle-slider {
        background: #00c2ff;
      }

      input:checked + .toggle-slider::after {
        transform: translateX(20px);
      }

      /* REMOVE BUTTON */
      .remove-btn {
        width: 100%;
        padding: 12px;
        border: 2px solid #ff6b6b;
        border-radius: 8px;
        background: transparent;
        color: #ff6b6b;
        font-weight: 600;
        cursor: pointer;
        margin-top: 20px;
        margin-bottom: 30px;
      }
    </style>
  </head>

  <body>
    <div class="settings-wrapper">
      <!-- HEADER -->
      <div class="settings-header">
        <div class="icon">⚙️</div>
        <h1>Progress Settings</h1>
      </div>

      <!-- TIME TRACKER COLLAPSIBLE -->
      <div class="collapsible" id="trackerHeader">
        <span><span id="arrow">⯈</span> Time Tracker</span>
        <span id="trackerElapsed">00:00:00</span>
      </div>

      <div id="trackerBox" style="display: none">
        <div class="time-row">
          <div>
            <div class="elapsed-label">Elapsed</div>
            <div id="elapsedLabel" class="elapsed">00:00:00</div>
          </div>

          <div>
            <div class="estimated-label">Estimated</div>
            <div id="estimatedDisplay" class="estimated">08:00:00 ✏️</div>
            <input id="estimatedInput" />
          </div>
        </div>

        <button id="trackBtn" class="track-btn">▶ Start Tracking</button>
        <button id="resetBtn" class="reset-btn">Reset</button>

        <div class="item" style="padding-top: 0">
          <span class="label">Enable automatic tracking</span>
          <label class="toggle">
            <input type="checkbox" id="autoTrack" />
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>

      <!-- BOARD SETTINGS -->
      <div class="section">
        <div class="item">
          <div>
            <div class="label">Hide card badges</div>
            <div class="desc">Remove from card front</div>
          </div>
          <label class="toggle"
            ><input type="checkbox" id="hideBadges" /><span
              class="toggle-slider"
            ></span
          ></label>
        </div>

        <div class="item">
          <div>
            <div class="label">Hide card detail badges</div>
            <div class="desc">In detailed card view</div>
          </div>
          <label class="toggle"
            ><input type="checkbox" id="hideDetail" /><span
              class="toggle-slider"
            ></span
          ></label>
        </div>

        <div class="item">
          <div>
            <div class="label">Hide progress bars</div>
            <div class="desc">Show % only</div>
          </div>
          <label class="toggle"
            ><input type="checkbox" id="hideBars" /><span
              class="toggle-slider"
            ></span
          ></label>
        </div>

        <div class="item">
          <div>
            <div class="label">Auto-enable Focus Mode</div>
            <div class="desc">Start focus when tracking begins</div>
          </div>
          <label class="toggle"
            ><input type="checkbox" id="focusMode" /><span
              class="toggle-slider"
            ></span
          ></label>
        </div>

        <div class="item">
          <div>
            <div class="label">Auto Tracking Mode</div>
            <div class="desc">Choose when timer auto-starts</div>
          </div>

          <select id="autoTrackMode">
            <option value="off">Off</option>
            <option value="open">On card open</option>
            <option value="list">On list move</option>
            <option value="both">Both</option>
          </select>
        </div>
      </div>

      <!-- REMOVE -->
      <button class="remove-btn" id="removeBtn">⚠️ Remove Power-Up</button>
    </div>

    <script>
      const t = TrelloPowerUp.iframe();

      let elapsed = 0,
        estimated = 8 * 3600,
        running = false,
        startTime = null,
        auto = false;
      let interval = null;

      const format = (s) => {
        const h = String(Math.floor(s / 3600)).padStart(2, "0");
        const m = String(Math.floor((s % 3600) / 60)).padStart(2, "0");
        const sec = String(s % 60).padStart(2, "0");
        return `${h}:${m}:${sec}`;
      };

      /* LOAD */
      (async function load() {
        const board = (await t.get("board", "shared")) || {};
        const card = (await t.get("card", "shared")) || {};

        elapsed = card.elapsed || 0;
        estimated = card.estimated || 8 * 3600;
        running = card.running || false;
        startTime = card.startTime || null;
        auto = card.auto || false;

        document.getElementById("elapsedLabel").textContent = format(elapsed);
        document.getElementById("trackerElapsed").textContent = format(elapsed);
        document.getElementById("estimatedDisplay").textContent =
          format(estimated) + " ✏️";

        document.getElementById("autoTrack").checked = auto;
        document.getElementById("hideBadges").checked =
          board.hideBadges || false;
        document.getElementById("hideDetail").checked =
          board.hideDetailBadges || false;
        document.getElementById("hideBars").checked =
          board.hideProgressBars || false;
        document.getElementById("focusMode").checked = board.autoFocus || false;
        document.getElementById("autoTrackMode").value =
          board.autoTrackMode || "off";

        if (running) startTick();

        setTimeout(() => t.sizeTo(document.body).done(), 40);
      })();

      function saveCard() {
        t.set("card", "shared", {
          elapsed,
          estimated,
          running,
          startTime,
          auto,
        });
      }

      function saveBoard(k, v) {
        t.set("board", "shared", k, v).then(() => t.refresh());
      }

      function startTick() {
        if (interval) return;
        interval = setInterval(() => {
          if (running) {
            const now = Date.now();
            const live = elapsed + Math.floor((now - startTime) / 1000);
            document.getElementById("elapsedLabel").textContent = format(live);
            document.getElementById("trackerElapsed").textContent =
              format(live);
          }
        }, 1000);
      }

      document.getElementById("trackBtn").onclick = () => {
        if (running) {
          const now = Date.now();
          elapsed += Math.floor((now - startTime) / 1000);
          running = false;
          startTime = null;
        } else {
          running = true;
          startTime = Date.now();
          startTick();

          t.get("board", "shared", "autoFocus").then((v) => {
            if (v) t.set("card", "shared", "focusMode", true);
          });
        }
        saveCard();
        document.getElementById("trackBtn").textContent = running
          ? "⏸ Stop Tracking"
          : "▶ Start Tracking";
      };

      document.getElementById("resetBtn").onclick = () => {
        elapsed = 0;
        running = false;
        startTime = null;
        saveCard();
        document.getElementById("elapsedLabel").textContent = "00:00:00";
        document.getElementById("trackerElapsed").textContent = "00:00:00";
      };

      document.getElementById("trackerHeader").onclick = () => {
        const box = document.getElementById("trackerBox");
        const arrow = document.getElementById("arrow");
        if (box.style.display === "none") {
          box.style.display = "block";
          arrow.textContent = "⯆";
        } else {
          box.style.display = "none";
          arrow.textContent = "⯈";
        }
        setTimeout(() => t.sizeTo(document.body).done(), 40);
      };

      document.getElementById("estimatedDisplay").onclick = () => {
        document.getElementById("estimatedDisplay").style.display = "none";
        const input = document.getElementById("estimatedInput");
        input.style.display = "block";
        input.value = format(estimated);
        input.focus();
      };

      document.getElementById("estimatedInput").onblur = () => {
        const val = document.getElementById("estimatedInput").value.trim();
        const [h, m, s] = val.split(":").map(Number);
        estimated = h * 3600 + m * 60 + s;
        saveCard();
        document.getElementById("estimatedDisplay").textContent = val + " ✏️";
        document.getElementById("estimatedDisplay").style.display = "block";
        document.getElementById("estimatedInput").style.display = "none";
      };

      document.getElementById("hideBadges").onchange = (e) =>
        saveBoard("hideBadges", e.target.checked);
      document.getElementById("hideDetail").onchange = (e) =>
        saveBoard("hideDetailBadges", e.target.checked);
      document.getElementById("hideBars").onchange = (e) =>
        saveBoard("hideProgressBars", e.target.checked);
      document.getElementById("focusMode").onchange = (e) =>
        saveBoard("autoFocus", e.target.checked);

      document.getElementById("autoTrackMode").onchange = (e) => {
        saveBoard("autoTrackMode", e.target.value).then(() => {
          if (e.target.value === "list" || e.target.value === "both") {
            t.popup({
              title: "Select Lists",
              url: "./auto-track-lists.html",
              height: 350,
            });
          }
        });
      };

      document.getElementById("autoTrack").onchange = (e) => {
        auto = e.target.checked;
        saveCard();
      };

      document.getElementById("removeBtn").onclick = async () => {
        if (!confirm("Remove and clear all data?")) return;
        await t.set("board", "shared", null);
        await t.set("card", "shared", null);
        await t.set("member", "private", null);
        await t.remove("member", "private", "authorized");
        t.closePopup();
      };
    </script>
  </body>
</html>
