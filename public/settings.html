<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <script src="https://p.trellocdn.com/power-up.min.js"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", sans-serif;
        background: transparent !important;
        color: #ffffff;
      }

      .settings-wrapper {
        padding: 20px;
        width: 360px;
        max-width: 100%;
      }

      /* HEADER */
      .settings-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 22px;
      }

      .settings-header .icon {
        font-size: 24px;
      }

      .settings-header h1 {
        font-size: 18px;
        font-weight: 600;
      }

      /* SECTION DIVIDER */
      .section {
        margin-top: 18px;
        padding-top: 4px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
      }

      /* ITEM */
      .item {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
        padding: 15px 0;
      }

      .item > div {
        display: flex;
        flex-direction: column;
        gap: 3px;
        flex: 1;
      }

      .label {
        font-size: 15px;
        font-weight: 500;
      }

      .desc {
        font-size: 13px;
        opacity: 0.75;
      }

      /* TOGGLE */
      .toggle {
        display: flex;
        align-items: center;
        flex-shrink: 0;
        margin-top: 3px;
      }

      .toggle input {
        display: none;
      }

      .toggle-slider {
        width: 46px;
        height: 24px;
        background: #bfbfbf;
        border-radius: 24px;
        position: relative;
        transition: 0.2s ease;
      }

      .toggle-slider::after {
        content: "";
        width: 20px;
        height: 20px;
        background: white;
        border-radius: 50%;
        position: absolute;
        top: 2px;
        left: 2px;
        transition: 0.25s ease;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.25);
      }

      .toggle input:checked + .toggle-slider {
        background: #00c2ff;
      }

      .toggle input:checked + .toggle-slider::after {
        transform: translateX(22px);
      }

      select {
        padding: 10px;
        background: #3a3a3a;
        border: 1px solid #555;
        border-radius: 6px;
        color: white;
        font-size: 15px;
      }

      /* REMOVE BUTTON */
      .remove-btn {
        width: 100%;
        padding: 14px;
        margin-top: 26px;
        background: transparent;
        border: 2px solid #ff6b6b;
        color: #ff6b6b;
        border-radius: 6px;
        font-size: 15px;
        font-weight: 600;
      }
    </style>
  </head>

  <body>
    <div class="settings-wrapper">
      <!-- HEADER -->
      <div class="settings-header">
        <div class="icon">⚙️</div>
        <h1>Customize your task card display</h1>
      </div>

      <!-- BOARD SETTINGS -->
      <div class="section">
        <div class="item">
          <div>
            <div class="label">Hide card badges</div>
            <div class="desc">Remove from card front</div>
          </div>
          <label class="toggle">
            <input type="checkbox" id="hideBadges" />
            <span class="toggle-slider"></span>
          </label>
        </div>

        <div class="item">
          <div>
            <div class="label">Hide timer badges</div>
            <div class="desc">Hide ⏱ timer from card</div>
          </div>
          <label class="toggle">
            <input type="checkbox" id="hideTimer" />
            <span class="toggle-slider"></span>
          </label>
        </div>

        <div class="item">
          <div>
            <div class="label">Hide card detail badges</div>
            <div class="desc">In detailed card view</div>
          </div>
          <label class="toggle">
            <input type="checkbox" id="hideDetail" />
            <span class="toggle-slider"></span>
          </label>
        </div>

        <div class="item">
          <div>
            <div class="label">Hide progress bars</div>
            <div class="desc">Show % only</div>
          </div>
          <label class="toggle">
            <input type="checkbox" id="hideBars" />
            <span class="toggle-slider"></span>
          </label>
        </div>

        <div class="item">
          <div>
            <div class="label">Auto-enable Focus Mode</div>
            <div class="desc">Start focus when tracking begins</div>
          </div>
          <label class="toggle">
            <input type="checkbox" id="focusMode" />
            <span class="toggle-slider"></span>
          </label>
        </div>

        <div class="item">
          <div>
            <div class="label">Auto Tracking Mode</div>
            <div class="desc">Choose when timer auto-starts</div>
          </div>

          <select id="autoTrackMode">
            <option value="off">Off</option>
            <option value="open">On card open</option>
          </select>
        </div>
      </div>

      <!-- REMOVE -->
      <button class="remove-btn" id="unauthBtn">⚠️ Unauthorize Power-Up</button>
    </div>

    <script>
      const t = TrelloPowerUp.iframe();

      (async function checkDisabled() {
        const disabled = await t.get("board", "shared", "disabled");
        if (disabled) {
          // Replace the whole UI with only an authorize button
          document.body.innerHTML = `
      <div style="padding:20px;text-align:center">
        <h3>Power-Up disabled</h3>
        <button id="authBtn" style="
          padding:12px 18px;
          margin-top:20px;
          border:none;
          background:#00c2ff;
          color:#fff;
          border-radius:6px;
          font-size:15px;
          cursor:pointer;">
          Click to Authorize
        </button>
      </div>
    `;

          document.getElementById("authBtn").onclick = function () {
            t.set("board", "shared", "disabled", false).then(() => {
              t.refresh();
              t.closePopup();
            });
          };
        }
      })();

      /* LOAD SETTINGS */
      (async function load() {
        const board = (await t.get("board", "shared")) || {};

        document.getElementById("hideBadges").checked =
          board.hideBadges || false;
        document.getElementById("hideDetail").checked =
          board.hideDetailBadges || false;
        document.getElementById("hideBars").checked =
          board.hideProgressBars || false;
        document.getElementById("focusMode").checked = board.autoFocus || false;
        document.getElementById("autoTrackMode").value =
          board.autoTrackMode || "off";

        document.getElementById("hideTimer").checked =
          board.hideTimerBadges || false;

        setTimeout(() => t.sizeTo(document.body).done(), 40);
      })();

      /* SAVE FUNCTIONS */
      function saveBoard(k, v) {
        return t.set("board", "shared", k, v);
      }

      /* EVENTS */
      document.getElementById("hideBadges").onchange = (e) =>
        saveBoard("hideBadges", e.target.checked);
        
      document.getElementById("hideTimer").onchange = async (e) => {
        await t.set("board", "shared", "hideTimerBadges", e.target.checked);
        t.refresh(); // ← REQUIRED
      };

      document.getElementById("hideDetail").onchange = (e) =>
        saveBoard("hideDetailBadges", e.target.checked);

      document.getElementById("hideBars").onchange = (e) =>
        saveBoard("hideProgressBars", e.target.checked);

      document.getElementById("focusMode").onchange = (e) =>
        saveBoard("autoFocus", e.target.checked);

      document.getElementById("autoTrackMode").onchange = (e) =>
        saveBoard("autoTrackMode", e.target.value);

      /* REMOVE POWER-UP */
      document.getElementById("unauthBtn").onclick = async () => {
        const ok = confirm("Remove and clear all saved data?");
        if (!ok) return;

        // 1️⃣ REMOVE BOARD DATA
        const board = (await t.get("board", "shared")) || {};
        for (const key of Object.keys(board)) {
          await t.remove("board", "shared", key);
        }

        // 2️⃣ REMOVE CARD DATA (only keys for current card)
        const card = (await t.get("card", "shared")) || {};
        for (const key of Object.keys(card)) {
          await t.remove("card", "shared", key);
        }

        // 3️⃣ REMOVE MEMBER PRIVATE DATA
        const mem = (await t.get("member", "private")) || {};
        for (const key of Object.keys(mem)) {
          await t.remove("member", "private", key);
        }

        // 4️⃣ SET DISABLED FLAG  ← ← ADD THIS
        await t.set("board", "shared", "disabled", true);

        alert("Power-Up data cleared. UI will disappear now.");

        t.closePopup();
      };
    </script>
  </body>
</html>
