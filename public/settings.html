<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <script src="https://p.trellocdn.com/power-up.min.js"></script>

    <style>
      /* RESET */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", sans-serif;
        background: transparent !important;
        color: #ffffff;
      }

      /* WRAPPER */
      .settings-wrapper {
        padding: 20px;
        width: 360px;
        max-width: 100%;
      }

      /* HEADER */
      .settings-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 22px;
      }

      .settings-header .icon {
        font-size: 24px;
      }

      .settings-header h1 {
        font-size: 18px;
        font-weight: 600;
      }

      /* COLLAPSIBLE */
      .collapsible {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 0;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
      }

      /* SECTION DIVIDER */
      .section {
        margin-top: 18px;
        padding-top: 4px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
      }

      /* ITEM — PERFECT TRELL0-STYLE SPACING */
      .item {
        display: flex;
        justify-content: space-between;
        align-items: flex-start; /* <— IMPORTANT: lets text wrap to 2 lines */
        gap: 12px; /* space between content & toggle */
        padding: 15px 0;
      }

      /* CONTENT WRAPPER (LABEL + DESCRIPTION) */
      .item > div {
        display: flex;
        flex-direction: column;
        gap: 3px;
        flex: 1;
        min-width: 0; /* Required so wrapping works properly */
      }

      .label {
        font-size: 15px;
        font-weight: 500;
        line-height: 1.35;
        color: #ffffff;
        white-space: normal; /* allow wrapping */
      }

      .desc {
        font-size: 13px;
        opacity: 0.75;
        line-height: 1.32;
        white-space: normal; /* allow wrapping */
      }

      /* TOGGLE */
      .toggle {
        display: flex;
        align-items: center;
        flex-shrink: 0;
        margin-top: 3px; /* aligns with label vertically */
      }

      .toggle input {
        display: none;
      }

      /* TOGGLE VISUAL */
      .toggle-slider {
        width: 46px;
        height: 24px;
        background: #bfbfbf;
        border-radius: 24px;
        position: relative;
        transition: 0.2s ease;
      }

      .toggle-slider::after {
        content: "";
        width: 20px;
        height: 20px;
        background: white;
        border-radius: 50%;
        position: absolute;
        top: 2px;
        left: 2px;
        transition: 0.25s ease;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.25);
      }

      .toggle input:checked + .toggle-slider {
        background: #00c2ff;
      }

      .toggle input:checked + .toggle-slider::after {
        transform: translateX(22px);
      }

      /* DROPDOWN */
      select {
        padding: 10px;
        background: #3a3a3a;
        border: 1px solid #555;
        border-radius: 6px;
        color: white;
        font-size: 15px;
      }

      /* REMOVE BUTTON */
      .remove-btn {
        width: 100%;
        padding: 14px;
        margin-top: 26px;
        background: transparent;
        border: 2px solid #ff6b6b;
        color: #ff6b6b;
        border-radius: 6px;
        font-size: 15px;
        font-weight: 600;
      }

      /* ------------------------------------------------------------
   RESTORE COLORFUL ORIGINAL TIME TRACKER STYLING
   ------------------------------------------------------------ */

      /* Tracker box — light card background */
      #trackerBox {
        background: rgba(
          71,
          85,
          105,
          0.32
        ) !important; /* slate/turquoise tint */
        border: 1px solid rgba(148, 163, 184, 0.35) !important;
        border-radius: 10px !important;
        padding: 16px !important;
        margin-top: 10px !important;
      }

      /* Title and elapsed label */
      #trackerHeader {
        color: #ddecf8 !important; /* soft bluish text */
        font-weight: 600 !important;
      }

      /* Elapsed & Estimated labels */
      #trackerBox .elapsed-label,
      #trackerBox .estimated-label {
        color: #bcd2e6 !important; /* soft pastel blue */
        font-weight: 500 !important;
      }

      /* Actual time values */
      #trackerBox .elapsed,
      #trackerBox .estimated {
        color: #ffffff !important;
        font-weight: 700 !important;
      }

      /* Pencil icon highlight */
      #estimatedDisplay {
        color: #ffd45a !important; /* warm highlight */
      }

      /* Buttons — restore your colourful UI */
      #trackBtn {
        background: #34d1c8 !important;
        color: #0a1f2b !important;
        border-radius: 6px !important;
        padding: 10px 14px !important;
        font-size: 14px !important;
        font-weight: 600 !important;
        border: none !important;
      }

      #resetBtn {
        background: #ff5f56 !important;
        color: white !important;
        border-radius: 6px !important;
        padding: 10px 14px !important;
        font-size: 14px !important;
        border: none !important;
        margin-left: 6px !important;
      }

      /* Toggle inside tracker */
      #trackerBox .toggle-slider {
        background: #9ca3af !important; /* light gray */
      }

      #trackerBox input:checked + .toggle-slider {
        background: #34d1c8 !important; /* turquoise */
      }
    </style>
  </head>

  <body>
    <div class="settings-wrapper">
      <!-- HEADER -->
      <div class="settings-header">
        <div class="icon">⚙️</div>
        <h1>Customize your task card display</h1>
      </div>

      <!-- TIME TRACKER COLLAPSIBLE -->
      <div class="collapsible" id="trackerHeader">
        <span><span id="arrow">⯈</span> Time Tracker</span>
        <span id="trackerElapsed">00:00:00</span>
      </div>

      <div id="trackerBox" style="display: none">
        <div class="time-row">
          <div>
            <div class="elapsed-label">Elapsed</div>
            <div id="elapsedLabel" class="elapsed">00:00:00</div>
          </div>

          <div>
            <div class="estimated-label">Estimated</div>
            <div id="estimatedDisplay" class="estimated">08:00:00 ✏️</div>
            <input id="estimatedInput" />
          </div>
        </div>

        <button id="trackBtn" class="track-btn">▶ Start Tracking</button>
        <button id="resetBtn" class="reset-btn">Reset</button>

        <div class="item" style="padding-top: 0">
          <span class="label">Enable automatic tracking</span>
          <label class="toggle">
            <input type="checkbox" id="autoTrack" />
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>

      <!-- BOARD SETTINGS -->
      <div class="section">
        <div class="item">
          <div>
            <div class="label">Hide card badges</div>
            <div class="desc">Remove from card front</div>
          </div>
          <label class="toggle"
            ><input type="checkbox" id="hideBadges" /><span
              class="toggle-slider"
            ></span
          ></label>
        </div>

        <div class="item">
          <div>
            <div class="label">Hide card detail badges</div>
            <div class="desc">In detailed card view</div>
          </div>
          <label class="toggle"
            ><input type="checkbox" id="hideDetail" /><span
              class="toggle-slider"
            ></span
          ></label>
        </div>

        <div class="item">
          <div>
            <div class="label">Hide progress bars</div>
            <div class="desc">Show % only</div>
          </div>
          <label class="toggle"
            ><input type="checkbox" id="hideBars" /><span
              class="toggle-slider"
            ></span
          ></label>
        </div>

        <div class="item">
          <div>
            <div class="label">Auto-enable Focus Mode</div>
            <div class="desc">Start focus when tracking begins</div>
          </div>
          <label class="toggle"
            ><input type="checkbox" id="focusMode" /><span
              class="toggle-slider"
            ></span
          ></label>
        </div>

        <div class="item">
          <div>
            <div class="label">Auto Tracking Mode</div>
            <div class="desc">Choose when timer auto-starts</div>
          </div>

          <select id="autoTrackMode">
            <option value="off">Off</option>
            <option value="open">On card open</option>
            <option value="list">On list move</option>
            <option value="both">Both</option>
          </select>
        </div>
      </div>

      <!-- REMOVE -->
      <button class="remove-btn" id="removeBtn">⚠️ Remove Power-Up</button>
    </div>

    <script>
      const t = TrelloPowerUp.iframe();

      let elapsed = 0,
        estimated = 8 * 3600,
        running = false,
        startTime = null,
        auto = false;
      let interval = null;

      const format = (s) => {
        const h = String(Math.floor(s / 3600)).padStart(2, "0");
        const m = String(Math.floor((s % 3600) / 60)).padStart(2, "0");
        const sec = String(s % 60).padStart(2, "0");
        return `${h}:${m}:${sec}`;
      };

      /* LOAD */
      (async function load() {
        const board = (await t.get("board", "shared")) || {};
        const card = (await t.get("card", "shared")) || {};

        elapsed = card.elapsed || 0;
        estimated = card.estimated || 8 * 3600;
        running = card.running || false;
        startTime = card.startTime || null;
        auto = card.auto || false;

        document.getElementById("elapsedLabel").textContent = format(elapsed);
        document.getElementById("trackerElapsed").textContent = format(elapsed);
        document.getElementById("estimatedDisplay").textContent =
          format(estimated) + " ✏️";

        document.getElementById("autoTrack").checked = auto;
        document.getElementById("hideBadges").checked =
          board.hideBadges || false;
        document.getElementById("hideDetail").checked =
          board.hideDetailBadges || false;
        document.getElementById("hideBars").checked =
          board.hideProgressBars || false;
        document.getElementById("focusMode").checked = board.autoFocus || false;
        document.getElementById("autoTrackMode").value =
          board.autoTrackMode || "off";

        if (running) startTick();

        setTimeout(() => t.sizeTo(document.body).done(), 40);
      })();

      function saveCard() {
        t.set("card", "shared", {
          elapsed,
          estimated,
          running,
          startTime,
          auto,
        });
      }

      function saveBoard(k, v) {
        t.set("board", "shared", k, v).then(() => t.refresh());
      }

      function startTick() {
        if (interval) return;
        interval = setInterval(() => {
          if (running) {
            const now = Date.now();
            const live = elapsed + Math.floor((now - startTime) / 1000);
            document.getElementById("elapsedLabel").textContent = format(live);
            document.getElementById("trackerElapsed").textContent =
              format(live);
          }
        }, 1000);
      }

      document.getElementById("trackBtn").onclick = () => {
        if (running) {
          const now = Date.now();
          elapsed += Math.floor((now - startTime) / 1000);
          running = false;
          startTime = null;
        } else {
          running = true;
          startTime = Date.now();
          startTick();

          t.get("board", "shared", "autoFocus").then((v) => {
            if (v) t.set("card", "shared", "focusMode", true);
          });
        }
        saveCard();
        document.getElementById("trackBtn").textContent = running
          ? "⏸ Stop Tracking"
          : "▶ Start Tracking";
      };

      document.getElementById("resetBtn").onclick = () => {
        elapsed = 0;
        running = false;
        startTime = null;
        saveCard();
        document.getElementById("elapsedLabel").textContent = "00:00:00";
        document.getElementById("trackerElapsed").textContent = "00:00:00";
      };

      document.getElementById("trackerHeader").onclick = () => {
        const box = document.getElementById("trackerBox");
        const arrow = document.getElementById("arrow");
        if (box.style.display === "none") {
          box.style.display = "block";
          arrow.textContent = "⯆";
        } else {
          box.style.display = "none";
          arrow.textContent = "⯈";
        }
        setTimeout(() => t.sizeTo(document.body).done(), 40);
      };

      document.getElementById("estimatedDisplay").onclick = () => {
        document.getElementById("estimatedDisplay").style.display = "none";
        const input = document.getElementById("estimatedInput");
        input.style.display = "block";
        input.value = format(estimated);
        input.focus();
      };

      document.getElementById("estimatedInput").onblur = () => {
        const val = document.getElementById("estimatedInput").value.trim();
        const [h, m, s] = val.split(":").map(Number);
        estimated = h * 3600 + m * 60 + s;
        saveCard();
        document.getElementById("estimatedDisplay").textContent = val + " ✏️";
        document.getElementById("estimatedDisplay").style.display = "block";
        document.getElementById("estimatedInput").style.display = "none";
      };

      document.getElementById("hideBadges").onchange = (e) =>
        saveBoard("hideBadges", e.target.checked);
      document.getElementById("hideDetail").onchange = (e) =>
        saveBoard("hideDetailBadges", e.target.checked);
      document.getElementById("hideBars").onchange = (e) =>
        saveBoard("hideProgressBars", e.target.checked);
      document.getElementById("focusMode").onchange = (e) =>
        saveBoard("autoFocus", e.target.checked);

      document.getElementById("autoTrackMode").onchange = (e) => {
        saveBoard("autoTrackMode", e.target.value).then(() => {
          if (e.target.value === "list" || e.target.value === "both") {
            t.popup({
              title: "Select Lists",
              url: "./auto-track-lists.html",
              height: 350,
            });
          }
        });
      };

      document.getElementById("autoTrack").onchange = (e) => {
        auto = e.target.checked;
        saveCard();
      };

      document.getElementById("removeBtn").onclick = async () => {
        if (!confirm("Remove and clear all data?")) return;
        await t.set("board", "shared", null);
        await t.set("card", "shared", null);
        await t.set("member", "private", null);
        await t.remove("member", "private", "authorized");
        t.closePopup();
      };
    </script>
  </body>
</html>
