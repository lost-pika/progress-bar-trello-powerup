<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://p.trellocdn.com/power-up.min.js"></script>

    <style>
      /* Trello sets data-color-mode on the root <html> for Power-Up iframes */
      html[data-color-mode="light"] {
        --surface: #ffffff;
        --text: #172b4d;
        --muted: rgba(23, 43, 77, 0.72);
        --divider: rgba(9, 30, 66, 0.13);
        --toggle-off: rgba(9, 30, 66, 0.18);
        --focus: #0c66e4;
        --danger: #cf513d;
      }
      html[data-color-mode="dark"] {
        --surface: #2b2d33; /* dark panel like competitor */
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.62);
        --divider: rgba(255, 255, 255, 0.12);
        --toggle-off: rgba(255, 255, 255, 0.22);
        --focus: #579dff;
        --danger: #f87168;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html,
      body {
        height: 100%;
      }

      /* IMPORTANT: don’t try to “inherit” Trello; paint your own surface per mode */
      body {
        background: var(--surface);
        color: var(--text);
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", sans-serif;
        padding: 16px;
      }

      .settings-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 14px;
      }

      .settings-header .icon {
        font-size: 22px;
        opacity: 0.9;
      }

      .settings-header h1 {
        font-size: 18px;
        font-weight: 650;
        line-height: 1.2;
      }

      .section {
        border-top: 1px solid var(--divider);
        padding-top: 10px;
        margin-top: 10px;
      }

      .item {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
        padding: 12px 0;
        border-bottom: 1px solid var(--divider);
      }

      .item:last-child {
        border-bottom: none;
      }

      .item > div {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .label {
        font-size: 14px;
        font-weight: 550;
      }

      .desc {
        font-size: 12px;
        color: var(--muted);
      }

      /* Toggle */
      .toggle {
        display: inline-flex;
        align-items: center;
        flex-shrink: 0;
        margin-top: 2px;
        user-select: none;
      }

      .toggle input {
        display: none;
      }

      .toggle-slider {
        width: 44px;
        height: 24px;
        background: var(--toggle-off);
        border-radius: 999px;
        position: relative;
        transition: 0.2s ease;
      }

      .toggle-slider::after {
        content: "";
        width: 20px;
        height: 20px;
        border-radius: 50%;
        position: absolute;
        top: 2px;
        left: 2px;
        background: #ffffff;
        transition: 0.2s ease;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.25);
      }

      .toggle input:checked + .toggle-slider {
        background: #22c55e;
      }

      .toggle input:checked + .toggle-slider::after {
        transform: translateX(20px);
      }

      select {
        padding: 8px 10px;
        background: transparent;
        border: 1px solid var(--divider);
        border-radius: 6px;
        color: inherit;
        font-size: 14px;
        min-width: 130px;
        outline: none;
      }

      select:focus {
        border-color: var(--focus);
      }

      .remove-btn {
        width: 100%;
        padding: 12px;
        margin-top: 16px;
        background: transparent;
        border: 2px solid var(--danger);
        color: var(--danger);
        border-radius: 8px;
        font-size: 14px;
        font-weight: 700;
        cursor: pointer;
      }

      .remove-btn:hover {
        background: rgba(207, 81, 61, 0.12);
      }
    </style>
  </head>

  <body>
    <div class="settings-header">
      <div class="icon">⚙️</div>
      <h1>Customize your task card display</h1>
    </div>

    <div class="section">
      <div class="item">
        <div>
          <div class="label">Hide card badges</div>
          <div class="desc">Remove from card front</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="hideBadges" />
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="item">
        <div>
          <div class="label">Hide timer badges</div>
          <div class="desc">Hide ⏱ timer from card</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="hideTimer" />
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="item">
        <div>
          <div class="label">Hide card detail badges</div>
          <div class="desc">In detailed card view</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="hideDetail" />
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="item">
        <div>
          <div class="label">Hide progress bars</div>
          <div class="desc">Show % only</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="hideBars" />
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="item">
        <div>
          <div class="label">Auto-enable Focus Mode</div>
          <div class="desc">Start focus when tracking begins</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="focusMode" />
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="item">
        <div>
          <div class="label">Auto Tracking Mode</div>
          <div class="desc">Choose when timer auto-starts</div>
        </div>

        <select id="autoTrackMode">
          <option value="off">Off</option>
          <option value="open">On card open</option>
        </select>
      </div>
    </div>

    <button class="remove-btn" id="unauthBtn">⚠️ Remove Power-Up</button>

    <script>
      const t = TrelloPowerUp.iframe();

      (async function load() {
        const board = (await t.get("board", "shared")) || {};

        document.getElementById("hideBadges").checked =
          board.hideBadges || false;
        document.getElementById("hideDetail").checked =
          board.hideDetailBadges || false;
        document.getElementById("hideBars").checked =
          board.hideProgressBars || false;
        document.getElementById("focusMode").checked = board.autoFocus || false;
        document.getElementById("autoTrackMode").value =
          board.autoTrackMode || "off";
        document.getElementById("hideTimer").checked =
          board.hideTimerBadges || false;

        setTimeout(() => t.sizeTo(document.body).done(), 40);
      })();

      function saveBoard(k, v) {
        return t.set("board", "shared", k, v);
      }

      document.getElementById("hideBadges").onchange = (e) =>
        saveBoard("hideBadges", e.target.checked);

      document.getElementById("hideTimer").onchange = async (e) => {
        await t.set("board", "shared", "hideTimerBadges", e.target.checked);
        t.refresh();
      };

      document.getElementById("hideDetail").onchange = (e) =>
        saveBoard("hideDetailBadges", e.target.checked);

      document.getElementById("hideBars").onchange = (e) =>
        saveBoard("hideProgressBars", e.target.checked);

      document.getElementById("focusMode").onchange = (e) =>
        saveBoard("autoFocus", e.target.checked);

      document.getElementById("autoTrackMode").onchange = (e) =>
        saveBoard("autoTrackMode", e.target.value);

      document.getElementById("unauthBtn").onclick = async () => {
        const ok = confirm("Remove and clear all saved data?");
        if (!ok) return;

        const board = (await t.get("board", "shared")) || {};
        for (const key of Object.keys(board))
          await t.remove("board", "shared", key);

        const card = (await t.get("card", "shared")) || {};
        for (const key of Object.keys(card))
          await t.remove("card", "shared", key);

        const mem = (await t.get("member", "private")) || {};
        for (const key of Object.keys(mem))
          await t.remove("member", "private", key);

        await t.set("board", "shared", "disabled", true);
        alert("Power-Up data cleared.");
        t.closePopup();
      };
    </script>
  </body>
</html>
