<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <script src="https://p.trellocdn.com/power-up.min.js"></script>

    <style>
      /* RESET */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", sans-serif;
        background: transparent !important;
        color: #ffffff;
      }

      /* WRAPPER */
      .settings-wrapper {
        padding: 20px;
        width: 360px;
        max-width: 100%;
      }

      /* HEADER */
      .settings-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 22px;
      }

      .settings-header .icon {
        font-size: 24px;
      }

      .settings-header h1 {
        font-size: 18px;
        font-weight: 600;
      }

      /* COLLAPSIBLE */
      .collapsible {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 0;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
      }

      /* SECTION DIVIDER */
      .section {
        margin-top: 18px;
        padding-top: 4px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
      }

      /* ITEM BLOCKS */
      .item {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
        padding: 15px 0;
      }

      .item > div {
        display: flex;
        flex-direction: column;
        gap: 3px;
        flex: 1;
        min-width: 0;
      }

      .label {
        font-size: 15px;
        font-weight: 500;
        line-height: 1.35;
      }

      .desc {
        font-size: 13px;
        opacity: 0.75;
        line-height: 1.32;
      }

      /* TOGGLE */
      .toggle {
        display: flex;
        align-items: center;
        flex-shrink: 0;
        margin-top: 3px;
      }

      .toggle input {
        display: none;
      }

      .toggle-slider {
        width: 46px;
        height: 24px;
        background: #bfbfbf;
        border-radius: 24px;
        position: relative;
        transition: 0.2s ease;
      }

      .toggle-slider::after {
        content: "";
        width: 20px;
        height: 20px;
        background: white;
        border-radius: 50%;
        position: absolute;
        top: 2px;
        left: 2px;
        transition: 0.25s ease;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.25);
      }

      .toggle input:checked + .toggle-slider {
        background: #00c2ff;
      }

      .toggle input:checked + .toggle-slider::after {
        transform: translateX(22px);
      }

      /* DROPDOWN */
      select {
        padding: 10px;
        background: #3a3a3a;
        border: 1px solid #555;
        border-radius: 6px;
        color: white;
        font-size: 15px;
      }

      /* REMOVE BUTTON */
      .remove-btn {
        width: 100%;
        padding: 14px;
        margin-top: 26px;
        background: transparent;
        border: 2px solid #ff6b6b;
        color: #ff6b6b;
        border-radius: 6px;
        font-size: 15px;
        font-weight: 600;
      }

      /* -----------------------------
         TIME TRACKER CLEAN + SMOOTH
      ------------------------------ */

      #trackerBox {
        display: none;
        max-height: 0;
        overflow: hidden;
        opacity: 0;
        transform: translateY(-4px);
        transition:
          max-height 0.35s ease,
          opacity 0.35s ease,
          transform 0.35s ease;
      }

      #trackerBox.open {
        opacity: 1;
        max-height: 500px;
        transform: translateY(0);
      }

      /* inner padding so the box doesn’t move */
      #trackerBox .inner {
        padding: 14px 0;
      }

      /* TIME ROW SIDE-BY-SIDE */
      #trackerBox .time-row {
        display: flex;
        justify-content: space-between;
        gap: 30px;
        width: 100%;
      }

      #trackerBox .time-row > div {
        flex: 1;
        min-width: 0;
      }

      /* BUTTONS */
      #trackBtn {
        background: #22d3c5 !important;
        color: #012629 !important;
        padding: 12px !important;
        border-radius: 6px !important;
        font-weight: 600 !important;
        border: none !important;
        width: 100%;
        margin: 12px 0 10px 0;
      }

      #resetBtn {
        background: #e74c3c !important;
        color: white !important;
        padding: 12px !important;
        border-radius: 6px !important;
        font-weight: 600 !important;
        border: none !important;
        width: 100%;
        margin-bottom: 12px;
      }

      /* HIDE INPUT EDIT FIELD COMPLETELY */
      #estimatedInput {
        display: none !important;
        visibility: hidden !important;
        height: 0 !important;
        width: 0 !important;
        border: none !important;
        padding: 0 !important;
        margin: 0 !important;
      }
    </style>
  </head>

  <body>
    <div class="settings-wrapper">
      <!-- HEADER -->
      <div class="settings-header">
        <div class="icon">⚙️</div>
        <h1>Customize your task card display</h1>
      </div>

      <!-- COLLAPSIBLE HEADER -->
      <div class="collapsible" id="trackerHeader">
        <span><span id="arrow">⯈</span> Time Tracker</span>
        <span id="trackerElapsed">00:00:00</span>
      </div>

      <!-- TIME TRACKER CONTENT -->
      <div id="trackerBox">
        <div class="inner">
          <div class="time-row">
            <div>
              <div class="elapsed-label">Elapsed</div>
              <div id="elapsedLabel" class="elapsed">00:00:00</div>
            </div>

            <div>
              <div class="estimated-label">Estimated</div>
              <div id="estimatedDisplay" class="estimated">08:00:00 ✏️</div>
              <input id="estimatedInput" />
            </div>
          </div>

          <button id="trackBtn">▶ Start Tracking</button>
          <button id="resetBtn">Reset</button>

          <div class="item" style="padding-top: 0">
            <span class="label">Enable automatic tracking</span>
            <label class="toggle">
              <input type="checkbox" id="autoTrack" />
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>
      </div>

      <!-- BOARD SETTINGS -->
      <div class="section">
        <div class="item">
          <div>
            <div class="label">Hide card badges</div>
            <div class="desc">Remove from card front</div>
          </div>
          <label class="toggle">
            <input type="checkbox" id="hideBadges" />
            <span class="toggle-slider"></span>
          </label>
        </div>

        <div class="item">
          <div>
            <div class="label">Hide card detail badges</div>
            <div class="desc">In detailed card view</div>
          </div>
          <label class="toggle">
            <input type="checkbox" id="hideDetail" />
            <span class="toggle-slider"></span>
          </label>
        </div>

        <div class="item">
          <div>
            <div class="label">Hide progress bars</div>
            <div class="desc">Show % only</div>
          </div>
          <label class="toggle">
            <input type="checkbox" id="hideBars" />
            <span class="toggle-slider"></span>
          </label>
        </div>

        <div class="item">
          <div>
            <div class="label">Auto-enable Focus Mode</div>
            <div class="desc">Start focus when tracking begins</div>
          </div>
          <label class="toggle">
            <input type="checkbox" id="focusMode" />
            <span class="toggle-slider"></span>
          </label>
        </div>

        <div class="item">
          <div>
            <div class="label">Auto Tracking Mode</div>
            <div class="desc">Choose when timer auto-starts</div>
          </div>

          <select id="autoTrackMode">
            <option value="off">Off</option>
            <option value="open">On card open</option>
            <option value="list">On list move</option>
            <option value="both">Both</option>
          </select>
        </div>
      </div>

      <!-- REMOVE POWER-UP -->
      <button class="remove-btn" id="removeBtn">⚠️ Remove Power-Up</button>
    </div>

    <script>
      const t = TrelloPowerUp.iframe();

      let elapsed = 0,
        estimated = 8 * 3600,
        running = false,
        startTime = null,
        auto = false;
      let interval = null;

      const format = (s) => {
        const h = String(Math.floor(s / 3600)).padStart(2, "0");
        const m = String(Math.floor((s % 3600) / 60)).padStart(2, "0");
        const sec = String(s % 60).padStart(2, "0");
        return `${h}:${m}:${sec}`;
      };

      /* LOAD INITIAL */
      (async function load() {
        const board = (await t.get("board", "shared")) || {};
        const card = (await t.get("card", "shared")) || {};

        elapsed = card.elapsed || 0;
        estimated = card.estimated || 8 * 3600;
        running = card.running || false;
        startTime = card.startTime || null;
        auto = card.auto || false;

        document.getElementById("elapsedLabel").textContent = format(elapsed);
        document.getElementById("trackerElapsed").textContent = format(elapsed);
        document.getElementById("estimatedDisplay").textContent =
          format(estimated) + " ✏️";

        document.getElementById("autoTrack").checked = auto;
        document.getElementById("hideBadges").checked =
          board.hideBadges || false;
        document.getElementById("hideDetail").checked =
          board.hideDetailBadges || false;
        document.getElementById("hideBars").checked =
          board.hideProgressBars || false;
        document.getElementById("focusMode").checked = board.autoFocus || false;
        document.getElementById("autoTrackMode").value =
          board.autoTrackMode || "off";

        if (running) startTick();

        setTimeout(() => t.sizeTo(document.body).done(), 40);
      })();

      function saveCard() {
        t.set("card", "shared", {
          elapsed,
          estimated,
          running,
          startTime,
          auto,
        });
      }

      function saveBoard(k, v) {
        t.set("board", "shared", k, v).then(() => t.refresh());
      }

      /* LIVE TIMER UPDATE */
      function startTick() {
        if (interval) return;
        interval = setInterval(() => {
          if (running) {
            const now = Date.now();
            const live = elapsed + Math.floor((now - startTime) / 1000);
            document.getElementById("elapsedLabel").textContent = format(live);
            document.getElementById("trackerElapsed").textContent =
              format(live);
          }
        }, 1000);
      }

      /* START/STOP */
      document.getElementById("trackBtn").onclick = () => {
        if (running) {
          const now = Date.now();
          elapsed += Math.floor((now - startTime) / 1000);
          running = false;
          startTime = null;
        } else {
          running = true;
          startTime = Date.now();
          startTick();

          t.get("board", "shared", "autoFocus").then((v) => {
            if (v) t.set("card", "shared", "focusMode", true);
          });
        }
        saveCard();
        document.getElementById("trackBtn").textContent = running
          ? "⏸ Stop Tracking"
          : "▶ Start Tracking";
      };

      /* RESET */
      document.getElementById("resetBtn").onclick = () => {
        elapsed = 0;
        running = false;
        startTime = null;
        saveCard();
        document.getElementById("elapsedLabel").textContent = "00:00:00";
        document.getElementById("trackerElapsed").textContent = "00:00:00";
      };

      /* OPEN/CLOSE TRACKER */
      document.getElementById("trackerHeader").onclick = () => {
        const box = document.getElementById("trackerBox");
        const arrow = document.getElementById("arrow");

        const isOpen = box.classList.contains("open");

        if (isOpen) {
          box.classList.remove("open");
          arrow.textContent = "⯈";

          setTimeout(() => {
            if (!box.classList.contains("open")) {
              box.style.display = "none";
            }
          }, 350);
        } else {
          box.style.display = "block";
          box.classList.add("open");
          arrow.textContent = "⯆";
        }

        setTimeout(() => t.sizeTo(document.body).done(), 350);
      };

      /* ESTIMATED EDIT — SIMPLE PROMPT */
      document.getElementById("estimatedDisplay").onclick = () => {
        const current = document
          .getElementById("estimatedDisplay")
          .textContent.replace(" ✏️", "");
        const updated = prompt("Enter new estimate (HH:MM:SS):", current);

        if (!updated) return;

        const [h, m, s] = updated.split(":").map(Number);
        estimated = h * 3600 + m * 60 + (s || 0);
        saveCard();

        document.getElementById("estimatedDisplay").textContent =
          updated + " ✏️";
      };

      /* BOARD SETTINGS SAVE */
      document.getElementById("hideBadges").onchange = (e) =>
        saveBoard("hideBadges", e.target.checked);
      document.getElementById("hideDetail").onchange = (e) =>
        saveBoard("hideDetailBadges", e.target.checked);
      document.getElementById("hideBars").onchange = (e) =>
        saveBoard("hideProgressBars", e.target.checked);
      document.getElementById("focusMode").onchange = (e) =>
        saveBoard("autoFocus", e.target.checked);

      document.getElementById("autoTrackMode").onchange = (e) => {
        saveBoard("autoTrackMode", e.target.value).then(() => {
          if (e.target.value === "list" || e.target.value === "both") {
            t.popup({
              title: "Select Lists",
              url: "./auto-track-lists.html",
              height: 350,
            });
          }
        });
      };

      /* TOGGLE AUTO TRACKING */
      document.getElementById("autoTrack").onchange = (e) => {
        auto = e.target.checked;
        saveCard();
      };

      /* REMOVE POWER-UP */
      document.getElementById("removeBtn").onclick = async () => {
        if (!confirm("Remove and clear all data?")) return;
        await t.set("board", "shared", null);
        await t.set("card", "shared", null);
        await t.set("member", "private", null);
        await t.remove("member", "private", "authorized");
        t.closePopup();
      };
    </script>
  </body>
</html>
