<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://p.trellocdn.com/power-up.min.js"></script>

    <style>
      :root {
        --primary: #2ec4b6;
        --primary-glow: rgba(46, 196, 182, 0.4);
        --danger: #ef476f;
        --danger-hover: #d6335a;
        --bg-card: #1f2329;
        --bg-input: #2c313a;
        --text-muted: #8b949e;
        --text-bright: #ffffff;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: transparent;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        color: var(--text-bright);
        padding: 8px; /* Compact outer padding */
      }

      /* Main container styles */
      .tracker-card {
        background: var(--bg-card);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        display: flex;
        flex-direction: column;
        gap: 16px;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
      }

      /* GLOW EFFECT when running */
      .tracker-card.is-running {
        border-color: rgba(46, 196, 182, 0.5);
        box-shadow: 0 0 15px rgba(46, 196, 182, 0.15);
      }

      /* --- TIMER DISPLAY AREA --- */
      .timer-display {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
      }

      .time-group {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .label {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
        color: var(--text-muted);
      }

      .digits {
        font-family: "SF Mono", "Monaco", "Inconsolata", "Fira Mono", monospace;
        font-variant-numeric: tabular-nums; /* Prevents jittering digits */
        font-weight: 600;
        line-height: 1;
      }

      /* Elapsed Time (Hero) */
      #elapsed {
        font-size: 28px;
        color: var(--text-bright);
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
      }
      
      .tracker-card.is-running #elapsed {
        color: var(--primary);
      }

      /* Estimated Time (Input) */
      .estimated-input {
        background: transparent;
        border: 1px solid transparent;
        color: var(--text-muted);
        font-family: "SF Mono", "Monaco", "Inconsolata", "Fira Mono", monospace;
        font-size: 16px;
        width: 80px;
        padding: 4px;
        border-radius: 6px;
        text-align: right;
        transition: all 0.2s;
        cursor: text;
      }

      .estimated-input:hover {
        background: var(--bg-input);
        color: var(--text-bright);
      }

      .estimated-input:focus {
        background: var(--bg-input);
        border-color: var(--primary);
        color: var(--text-bright);
        outline: none;
      }

      /* --- WARNING STATUS --- */
      .status-warning {
        font-size: 12px;
        color: #ffb84a;
        background: rgba(255, 184, 74, 0.1);
        padding: 6px 10px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        gap: 6px;
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

      /* --- CONTROLS ROW --- */
      .controls {
        display: flex;
        gap: 8px;
        height: 44px; /* Fixed height for alignment */
      }

      /* Main Toggle Button */
      .btn-toggle {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
        user-select: none;
        font-size: 14px;
        font-weight: 600;
        border: none;
        outline: none;
        
        /* Default Off State */
        background: #2c313a; 
        color: var(--text-bright);
        border: 1px solid rgba(255,255,255,0.1);
      }

      .btn-toggle:hover {
        background: #363c46;
      }

      .btn-toggle:active {
        transform: scale(0.98);
      }

      /* Active (Running) State */
      .btn-toggle.active {
        background: rgba(46, 196, 182, 0.2);
        border: 1px solid var(--primary);
        color: var(--primary);
      }

      /* The visual slider/switch inside the button */
      .switch-indicator {
        width: 32px;
        height: 18px;
        background: rgba(0,0,0,0.3);
        border-radius: 20px;
        position: relative;
        transition: 0.3s;
      }
      .switch-indicator::after {
        content: '';
        position: absolute;
        left: 2px; top: 2px;
        width: 14px; height: 14px;
        background: #8b949e;
        border-radius: 50%;
        transition: 0.3s;
      }
      .btn-toggle.active .switch-indicator {
        background: var(--primary);
      }
      .btn-toggle.active .switch-indicator::after {
        transform: translateX(14px);
        background: #fff;
      }

      /* Reset Button */
      .btn-reset {
        width: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(239, 71, 111, 0.15);
        color: var(--danger);
        border: 1px solid transparent;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn-reset:hover {
        background: var(--danger);
        color: white;
      }
      
      /* Simple SVG icons */
      .icon { width: 18px; height: 18px; fill: currentColor; }

    </style>
  </head>

  <body>
    <div id="root"></div>

    <script>
      const t = TrelloPowerUp.iframe();

      let state = {
        progress: 0,
        elapsed: 0,
        estimated: 8 * 3600,
        running: false,
        startTime: null,
        hideProgressBars: false,
      };

      let timer = null;

      /* FORMATTER */
      function format(s) {
        const h = String(Math.floor(s / 3600)).padStart(2, "0");
        const m = String(Math.floor((s % 3600) / 60)).padStart(2, "0");
        const sec = String(s % 60).padStart(2, "0");
        return `${h}:${m}:${sec}`;
      }

      window.addEventListener("message", async (event) => {
        if (event.data && event.data.type === "PROGRESS_UPDATED") {
          const { progress } = event.data;
          state.progress = progress;
          await t.set("card", "shared", "progress", progress);
          render();
        }
      });

      /* LOAD STATE */
      async function load() {
        const card = (await t.get("card", "shared")) || {};
        const hideBars = await t.get("board", "shared", "hideProgressBars");

        state.progress = card.progress || 0;
        state.elapsed = card.elapsed || 0;
        state.estimated = card.estimated || 8 * 3600;
        state.running = card.running || false;
        state.startTime = card.startTime || null;
        state.hideProgressBars = hideBars || false;

        render();

        if (state.running) startTick();

        setTimeout(() => t.sizeTo(document.body).done(), 40);
      }

      load().then(() => {
        t.get("board", "shared", "autoTrackMode").then(async (mode) => {
          const card = await t.get("card", "shared");
          if ((mode === "open" || mode === "both") && card?.estimated > 0 && !state.running) {
            state.running = true;
            state.startTime = Date.now();
            state.elapsed = card?.elapsed || 0;
            startTick();
            save();
            t.get("board", "shared", "autoFocus").then((f) => {
              if (f) t.set("card", "shared", "focusMode", true);
            });
            render();
          }
        });
      });

      /* SAVE */
      function save() {
        t.set("card", "shared", state);
      }

      /* TIMER LOGIC */
      function startTick() {
        if (timer) return;
        timer = setInterval(() => {
          if (state.running) {
            const now = Date.now();
            const live = state.elapsed + Math.floor((now - state.startTime) / 1000);
            const elDisplay = document.getElementById("elapsed");
            if(elDisplay) elDisplay.textContent = format(live);
          }
        }, 1000);
      }

      function toggleTimer() {
        if (state.running) {
          const now = Date.now();
          state.elapsed += Math.floor((now - state.startTime) / 1000);
          state.running = false;
          state.startTime = null;
          t.set("card", "shared", "focusMode", false);
        } else {
          state.running = true;
          state.startTime = Date.now();
          startTick();
          t.get("board", "shared", "autoFocus").then((f) => {
            if (f) t.set("card", "shared", "focusMode", true);
          });
        }
        save();
        render();
      }

      function resetTimer() {
        state.elapsed = 0;
        state.running = false;
        state.startTime = null;
        t.set("card", "shared", "focusMode", false);
        save();
        render();
      }

      /* RENDER UI */
      function render() {
        const live = state.running
          ? state.elapsed + Math.floor((Date.now() - state.startTime) / 1000)
          : state.elapsed;

        const behind = live > state.estimated;

        // SVG Icons
        const iconReset = `<svg class="icon" viewBox="0 0 24 24"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm-4.43 1.57L6.1 7.05C4.8 8.35 4 10.08 4 12c0 4.42 3.58 8 8 8 1.61 0 3.09-.59 4.23-1.57l-1.42-1.42c-.84.6-1.84.99-2.81.99-2.76 0-5-2.24-5-5 0-1.65.8-3.16 2-4.14z"/></svg>`;

        document.getElementById("root").innerHTML = `
          <div class="tracker-card ${state.running ? 'is-running' : ''}">
            
            <div class="timer-display">
              <div class="time-group">
                <span class="label">Elapsed Time</span>
                <span id="elapsed" class="digits">${format(live)}</span>
              </div>

              <div class="time-group" style="align-items: flex-end;">
                <span class="label">Estimated</span>
                <input id="estimatedInput" class="estimated-input digits" value="${format(state.estimated)}" />
              </div>
            </div>

            ${behind ? `
              <div class="status-warning">
                <span>âš </span> <strong>Overtime:</strong> You have exceeded the estimate.
              </div>` : ""
            }

            <div class="controls">
              
              <button id="trackToggle" class="btn-toggle ${state.running ? 'active' : ''}">
                <div class="switch-indicator"></div>
                <span>${state.running ? "Tracking Active" : "Start Tracking"}</span>
              </button>

              <button id="resetBtn" class="btn-reset" title="Reset Timer">
                ${iconReset}
              </button>

            </div>

          </div>
        `;

        // Event Listeners
        document.getElementById("resetBtn").onclick = resetTimer;
        document.getElementById("trackToggle").onclick = toggleTimer;

        // Input Logic
        const estInput = document.getElementById("estimatedInput");
        estInput.onchange = (e) => {
          const val = e.target.value.trim();
          const parts = val.split(":").map(Number);
          let h = 0, m = 0, s = 0;

          if (parts.length === 3) [h, m, s] = parts;
          else if (parts.length === 2) { m = parts[0]; s = parts[1]; }
          else if (parts.length === 1) { s = parts[0]; }

          const total = h * 3600 + m * 60 + s;

          if (!isNaN(total) && total > 0) {
            state.estimated = total;
            save();
            render();
          } else {
            e.target.value = format(state.estimated);
          }
        };
      }

      load();
    </script>
  </body>
</html>